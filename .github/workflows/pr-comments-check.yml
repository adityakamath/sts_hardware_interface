name: PR Comments Check

# DISABLED FOR PRIVATE REPO - Enable when repo becomes public (uncomment lines below)
on:
  # pull_request:
  #   types: [opened, synchronize, reopened, edited]
  # pull_request_review:
  #   types: [submitted, edited, dismissed]
  # pull_request_review_comment:
  #   types: [created, edited, deleted]
  # issue_comment:
  #   types: [created, edited, deleted]
  workflow_dispatch:

jobs:
  check-unresolved-comments:
    name: Check Unresolved Comments
    runs-on: ubuntu-24.04
    if: github.event.pull_request || github.event.issue.pull_request

    steps:
      - name: Get PR number
        id: pr
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Check for unresolved review comments
        id: review_comments
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.pulls.listReviewComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.pr.outputs.number }}
            });

            // Filter for unresolved comments from bots and humans
            const unresolvedComments = comments.filter(comment => {
              // GitHub's review comments don't have explicit "resolved" status in API
              // We check if the comment thread is still active
              return comment.in_reply_to_id === undefined || comment.id;
            });

            const botComments = unresolvedComments.filter(c =>
              c.user.login.includes('coderabbit') ||
              c.user.login.includes('copilot') ||
              c.user.login.includes('github-actions') ||
              c.body.includes('clang-tidy')
            );

            const humanComments = unresolvedComments.filter(c =>
              !c.user.login.includes('bot') &&
              !c.user.login.includes('coderabbit') &&
              !c.user.login.includes('copilot') &&
              !c.user.login.includes('github-actions')
            );

            console.log(`Total review comments: ${comments.length}`);
            console.log(`Unresolved bot comments: ${botComments.length}`);
            console.log(`Unresolved human comments: ${humanComments.length}`);

            return {
              total: comments.length,
              botCount: botComments.length,
              humanCount: humanComments.length,
              hasUnresolved: botComments.length > 0 || humanComments.length > 0
            };

      - name: Check for unresolved conversations
        id: conversations
        uses: actions/github-script@v7
        with:
          script: |
            // Use GraphQL to check for unresolved review threads
            const query = `
              query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  pullRequest(number: $number) {
                    reviewThreads(first: 100) {
                      nodes {
                        isResolved
                        comments(first: 1) {
                          nodes {
                            author {
                              login
                            }
                            body
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const variables = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              number: ${{ steps.pr.outputs.number }}
            };

            try {
              const result = await github.graphql(query, variables);
              const threads = result.repository.pullRequest.reviewThreads.nodes;

              const unresolvedThreads = threads.filter(thread => !thread.isResolved);

              const botThreads = unresolvedThreads.filter(thread => {
                const author = thread.comments.nodes[0]?.author?.login || '';
                const body = thread.comments.nodes[0]?.body || '';
                return author.includes('coderabbit') ||
                       author.includes('copilot') ||
                       author.includes('github-actions') ||
                       body.includes('clang-tidy');
              });

              const humanThreads = unresolvedThreads.filter(thread => {
                const author = thread.comments.nodes[0]?.author?.login || '';
                return !author.includes('bot') &&
                       !author.includes('coderabbit') &&
                       !author.includes('copilot') &&
                       !author.includes('github-actions');
              });

              console.log(`Total threads: ${threads.length}`);
              console.log(`Unresolved threads: ${unresolvedThreads.length}`);
              console.log(`Unresolved bot threads: ${botThreads.length}`);
              console.log(`Unresolved human threads: ${humanThreads.length}`);

              return {
                total: threads.length,
                unresolved: unresolvedThreads.length,
                botThreads: botThreads.length,
                humanThreads: humanThreads.length
              };
            } catch (error) {
              console.log('GraphQL query failed, falling back to basic check');
              return {
                total: 0,
                unresolved: 0,
                botThreads: 0,
                humanThreads: 0
              };
            }

      - name: Check for blocking review comments
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const conversations = ${{ steps.conversations.outputs.result }};
            const unresolvedBotThreads = conversations.botThreads || 0;
            const unresolvedHumanThreads = conversations.humanThreads || 0;
            const totalUnresolved = conversations.unresolved || 0;

            let message = '## ðŸ’¬ PR Comment Resolution Status\n\n';

            if (totalUnresolved === 0) {
              message += 'âœ… **All review conversations are resolved!**\n\n';
              message += 'This PR is ready for merge from a review perspective.\n';
              core.setOutput('status', 'success');
              core.setOutput('message', message);
              return;
            }

            message += `### âš ï¸ Unresolved Conversations: ${totalUnresolved}\n\n`;

            if (unresolvedBotThreads > 0) {
              message += `- ðŸ¤– **Bot Reviews**: ${unresolvedBotThreads} unresolved\n`;
              message += `  - Includes: CodeRabbit, GitHub Copilot, clang-tidy\n`;
            }

            if (unresolvedHumanThreads > 0) {
              message += `- ðŸ‘¤ **Human Reviews**: ${unresolvedHumanThreads} unresolved\n`;
            }

            message += '\n### ðŸ“‹ Action Required\n\n';
            message += 'Please address all review comments by either:\n';
            message += '1. **Fixing** the issues and pushing new commits\n';
            message += '2. **Responding** with explanations if you disagree\n';
            message += '3. **Resolving** the conversation if the issue is addressed\n\n';
            message += '> **Note:** All conversations must be marked as resolved before merging.\n';

            core.setOutput('status', 'failure');
            core.setOutput('message', message);
            core.setFailed(`${totalUnresolved} unresolved conversation(s) found`);

      - name: Update PR status comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const message = `${{ steps.check.outputs.message }}`;

            // Find existing status comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }}
            });

            const botComment = comments.find(comment =>
              comment.user.login === 'github-actions[bot]' &&
              comment.body.includes('PR Comment Resolution Status')
            );

            const commentBody = message + '\n\n---\n*This check runs automatically on every PR update.*';

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ steps.pr.outputs.number }},
                body: commentBody
              });
            }

      - name: Set check status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.check.outputs.status }}';
            const conversations = ${{ steps.conversations.outputs.result }};

            if (status === 'failure') {
              core.setFailed(`Cannot merge: ${conversations.unresolved} unresolved conversation(s)`);
            }
